<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="./assets/favicon.ico" />
    <title>短连接</title>
    <link rel="stylesheet" href="./assets/css/404.css" />

    <!-- 添加依赖库 -->
    <script src="./libs/marked/marked.min.js"></script>
    <link rel="stylesheet" href="./libs/github-markdown-css/github-markdown.min.css">
    <script src="./libs/highlight.js/highlight.min.js"></script>
    <!-- 浅色模式默认主题 -->
    <link rel="stylesheet" 
    href="./libs/highlight.js/styles/github.min.css">
    <!-- 深色模式覆盖主题 -->
    <link rel="stylesheet" 
    href="./libs/highlight.js/styles/github-dark.min.css"
    media="(prefers-color-scheme: dark)">
    
    <script>
      // Markdown 配置
      marked.setOptions({
        breaks: true,
        gfm: true,
        sanitize: true,
        highlight: function(code, lang) {
          return hljs.highlightAuto(code).value;
        }
      });

      var PATH_SEGMENTS_TO_SKIP = 0;

      function isUrl(url) {
        return /^[a-zA-z]+:\/\/[^\s]*$/.test(url);
      }

      function returnHome() {
        window.location.replace(
          location.protocol +
            '//' +
            location.hostname +
            (location.port ? ':' + location.port : '') +
            '/' +
            location.pathname.split('/')[PATH_SEGMENTS_TO_SKIP]
        );
      }

      function copyText() {
        const rawText = document.querySelector(".markdown-body").dataset.raw;
        const copyBtn = document.querySelector(".copy-button");
        
        const textarea = document.createElement("textarea");
        textarea.value = rawText;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand("copy");
        document.body.removeChild(textarea);

        copyBtn.innerText = '已复制';
        setTimeout(() => {
          copyBtn.innerText = '复制';
        }, 1000);
      }

      function redirect() {
        var GITEE_ISSUES_LINK = atob('aHR0cHM6Ly9naXRlZS5jb20vYXBpL3Y1L3JlcG9zL3p3OTVjbi9zaG9ydHVybC1kYi9pc3N1ZXMv');
        var location = window.location;
        var issueNumber = location.pathname.split('/')[PATH_SEGMENTS_TO_SKIP + 1];
        var xhr = new XMLHttpRequest();

        xhr.onload = function () {
          if (xhr.status === 200) {
            var payload = JSON.parse(xhr.response);
            var message = payload.message;
            var titleText = payload.title;
            var bodyText = payload.body;
            var timeText = payload.updated_at;  

            var isInvalidUrl = message === 'Not Found' || 
                             message === 'This issue was deleted' || 
                             !titleText || 
                             (!isUrl(titleText) && !isUrl(bodyText));

            if (isInvalidUrl) {
              document.title = titleText;
              let container = document.createElement('div');
              container.className = 'container';

              let divObj = document.createElement('div');
              divObj.className = 'box';

              let titleObj = document.createElement('h1');
              titleObj.className = 'titleText';
              titleObj.textContent = titleText;

              let timeObj = document.createElement('p');
              timeObj.className = 'timeText';
              let textTime = new Date(timeText);
              timeObj.textContent = textTime.toLocaleString();

              let copyBtnObj = document.createElement('button');
              copyBtnObj.className = 'copy-button';
              copyBtnObj.textContent = '复制';
              copyBtnObj.addEventListener('click', copyText);

              let bodyObj = document.createElement('div');
              bodyObj.className = 'markdown-body';
              bodyObj.innerHTML = marked.parse(bodyText);
              bodyObj.dataset.raw = bodyText; // 保存原始文本

              divObj.appendChild(titleObj);
              divObj.appendChild(timeObj);
              divObj.appendChild(copyBtnObj);
              divObj.appendChild(bodyObj);
              container.appendChild(divObj);
              document.body.appendChild(container);

              // 代码高亮
              hljs.highlightAll();
            } else {
              document.title = '跳转中...';
              isUrl(titleText) ? location.replace(titleText) : location.replace(bodyText);
            }
          } else {
            console.error(xhr.status+' '+xhr.response);
            returnHome();
          }
        };

        xhr.onerror = returnHome;
        xhr.open('GET', GITEE_ISSUES_LINK + issueNumber);
        xhr.send();
      }

      try {
        redirect();
      } catch (e) {
        console.error(e);
        returnHome();
      }
    </script>
  </head>
  <body></body>
</html>