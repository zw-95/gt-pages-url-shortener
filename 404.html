<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="./assets/favicon.ico" />
    <title>短连接</title>

    <!-- 添加依赖库 -->
    <script src="./libs/marked/marked.min.js"></script>
    <link rel="stylesheet" href="./libs/github-markdown-css/github-markdown.css" />
    <script src="./libs/highlight.js/highlight.min.js"></script>
    <!-- 浅色模式默认主题 -->
    <link rel="stylesheet" href="./libs/highlight.js/styles/github.min.css" />
    <!-- 深色模式覆盖主题 -->
    <link rel="stylesheet" href="./libs/highlight.js/styles/github-dark.min.css" media="(prefers-color-scheme: dark)" />
    <!-- 该页面自定义主题 -->
    <link rel="stylesheet" href="./assets/css/base.css" />
    <link rel="stylesheet" href="./assets/css/404.css" />
    <script src="./libs/func/func.js"></script>
    <script>
      // Markdown 配置
      marked.setOptions({
        breaks: true,
        gfm: true,
        sanitize: true,
        highlight: function (code, lang) {
          return hljs.highlightAuto(code).value;
        },
      });

      var PATH_SEGMENTS_TO_SKIP = 0;

      function isUrl(url) {
        return /^[a-zA-z]+:\/\/[^\s]*$/.test(url);
      }

      function returnHome() {
        window.location.replace(
          location.protocol +
            '//' +
            location.hostname +
            (location.port ? ':' + location.port : '') +
            '/' +
            location.pathname.split('/')[PATH_SEGMENTS_TO_SKIP]
        );
      }

      function processContent(isInvalidUrl, titleText, bodyText, timeText, userName) {
        if (isInvalidUrl) {
          document.title = titleText;
          let container = document.createElement('div');
          container.className = 'container';

          let divObj = document.createElement('div');
          divObj.className = 'box';

          let titleObj = document.createElement('h1');
          titleObj.className = 'titleText';
          titleObj.textContent = titleText;

          // 创建元信息容器
          let metaContainer = document.createElement('div');
          metaContainer.className = 'meta-info';

          // 时间元素
          let timeObj = document.createElement('p');
          timeObj.className = 'timeText';
          let textTime = new Date(timeText);
          timeObj.textContent = textTime.toLocaleString();

          // 作者元素
          let authorObj = document.createElement('span');
          authorObj.className = 'authorText';
          authorObj.textContent = userName ? `作者：${userName}` : '';

          // 组装元素
          metaContainer.appendChild(timeObj);
          metaContainer.appendChild(authorObj);

          let bodyObj = document.createElement('div');
          bodyObj.className = 'markdown-body';
          bodyObj.innerHTML = marked.parse(bodyText);
          bodyObj.dataset.raw = bodyText; // 保存原始文本

          divObj.appendChild(titleObj);
          divObj.appendChild(metaContainer);
          divObj.appendChild(bodyObj);

          let toolbar = document.getElementById('toolbar');
          if (toolbar) {
            toolbar.style.position = 'center';
            toolbar.style.marginTop = '2rem';
            toolbar.style.marginRight = '1rem';
            let copyBtnObj = document.createElement('button');
            copyBtnObj.className = 'copy-button';
            copyBtnObj.title = '复制全文';
            copyBtnObj.innerHTML =
              '<svg t="1756500054955" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="17081" width="1rem" ><path d="M864 128H352a32 32 0 0 0-32 32v160H160a32 32 0 0 0-32 32v512a32 32 0 0 0 32 32h512a32 32 0 0 0 32-32v-160h160a32 32 0 0 0 32-32V160a32 32 0 0 0-32-32z m-224 704H192V384h448v448z m192-192h-128v-288a32 32 0 0 0-32-32h-288V192h448v448z" p-id="17082"></path></svg>';
            copyBtnObj.addEventListener('click', function () {
              if (this.disabled) return;
              this.disabled = true;

              const rawText = document.querySelector('.markdown-body').dataset.raw;

              copyRichText(rawText, {isRawText:true})

              var originHTML = this.innerHTML;
              var originBackgroundColor = this.innerHTML;

              this.innerHTML =
                '<svg t="1756499921384" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="16807" width="1rem" ><path d="M918.656 310.656l-512 512a32.032 32.032 0 0 1-45.28 0l-224-224a32 32 0 1 1 45.28-45.28L384 754.72 873.376 265.376a32 32 0 1 1 45.28 45.28z" p-id="16808" fill="#34A853"></path></svg>';
              this.querySelector('svg.icon')?.classList.add('icon-success');
              setTimeout(() => {
                this.classList.remove('icon-success');
                this.querySelector('svg.icon')?.classList.remove('icon-success');
                this.innerHTML = originHTML;
                this.disabled = false;
              }, 1000);
            });
            toolbar.appendChild(copyBtnObj);
            container.appendChild(toolbar);
          }

          container.appendChild(divObj);
          document.body.appendChild(container);


          // 代码高亮
          hljs.highlightAll();
        } else {
          document.title = '跳转中...';
          var url = isUrl(titleText) ? titleText : bodyText;

          let linkToBox = document.createElement('div');
          linkToBox.classList.add('link-to-box');
          linkToBox.innerHTML = `<span class="title">跳转中...</span><span class="subTitle"><a href="${url}" target="_blank">${url}</a></span>`;
          document.body.appendChild(linkToBox);
          location.replace(url);
        }
      }

      function redirect() {
        var location = window.location;
        var issueNumber = location.pathname.split('/')[PATH_SEGMENTS_TO_SKIP + 1];
        var GITEE_ISSUE_API_URL = atob('aHR0cHM6Ly9naXRlZS5jb20vYXBpL3Y1L3JlcG9zL3p3OTVjbi9zaG9ydHVybC1kYi9pc3N1ZXMv') + issueNumber;
        var xhr = new XMLHttpRequest();

        xhr.onload = function () {
          // 原本执行主题切换处

          if (xhr.status === 200) {
            var payload = JSON.parse(xhr.response);
            var message = payload.message;
            var titleText = payload.title;
            var bodyText = payload.body;
            var timeText = payload.updated_at;
            var userName = payload.user?.name || '';

            var isInvalidUrl =
              message === 'Not Found' ||
              message === 'This issue was deleted' ||
              !titleText ||
              (!isUrl(titleText) && !isUrl(bodyText));

            processContent(isInvalidUrl, titleText, bodyText, timeText, userName);
          } else {
            console.error(xhr.status + ' ' + xhr.response);
            returnHome();
          }
        };

        xhr.onerror = returnHome;
        xhr.open('GET', GITEE_ISSUE_API_URL);
        xhr.send();
      }

      try {
        redirect();
      } catch (e) {
        console.error(e);
        returnHome();
      }
    </script>
  </head>

  <body>
    <div id="toolbar">
    </div>
  </body>
  <script src="./libs/theme-switch/theme-switch.js"></script>
</html>
