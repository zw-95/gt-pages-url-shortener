<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="./assets/favicon.ico" />
    <title>短连接</title>

    <!-- 添加依赖库 -->
    <script src="../libs/marked/marked.min.js"></script>
    <link rel="stylesheet" href="../libs/github-markdown-css/github-markdown.min.css">
    <script src="../libs/highlight.js/highlight.min.js"></script>
    <!-- 浅色模式默认主题 -->
    <link rel="stylesheet" 
    href="../libs/highlight.js/styles/github.min.css">
    <!-- 深色模式覆盖主题 -->
    <link rel="stylesheet" 
    href="../libs/highlight.js/styles/github-dark.min.css"
    media="(prefers-color-scheme: dark)">
    <style>
      :root {
        /* 浅色模式默认值 */
        --page-bg: #ffffff;
        --card-bg-start: #fafafa;
        --card-bg-end: #ebebeb;
        --title-color: #353535;
        --text-color: #353535;
        --secondary-text: #767676;
        --code-bg: #f6f8fa;
        --border-color: #eaecef;
        --shadow-main: 0 5px 15px 0 rgba(0,0,0,0.15);
        --shadow-hover: 0 5px 5px 0 rgba(0,0,0,0.15);
        --button-border: #a5dc86;
        --button-text: #a5dc86;
        --button-hover-bg: #a5dc86;
        --font-family: system-ui, 'Microsoft YaHei', sans-serif;
      }

      /* 深色模式覆盖 */
      @media (prefers-color-scheme: dark) {
        :root {
          --page-bg: #1a1a1a;
          --card-bg-start: #2d2d2d;
          --card-bg-end: #1a1a1a;
          --title-color: #e0e0e0;
          --text-color: #cccccc;
          --secondary-text: #909090;
          --code-bg: #2d2d2d;
          --border-color: #404040;
          --shadow-main: 0 5px 15px 0 rgba(0,0,0,0.4);
          --shadow-hover: 0 5px 5px 0 rgba(0,0,0,0.4);
          --button-border: #6a9955;
          --button-text: #6a9955;
          --button-hover-bg: #6a9955;
        }
      }

      body {
        font-family: var(--font-family);
        background: var(--page-bg);
        color: var(--text-color);
        line-height: 1.5;
        margin: 0;
        padding: 20px;
        transition: background-color 0.3s ease, color 0.3s ease;
      }

      button{
        font-family: var(--font-family);
      }

      .container {
        max-width: 980px;
        margin: 0 auto;
      }

      .box {
        margin: 2rem 0;
        padding: 1rem !important;
        background: linear-gradient(135deg, var(--card-bg-start), var(--card-bg-end));
        border-radius: 10px;
        box-shadow: var(--shadow-main);
        transition: all 0.3s ease;
      }

      .box:hover {
        box-shadow: var(--shadow-hover);
      }

      .titleText {
        font-size: 2em !important;
        border-bottom: 1px solid var(--border-color);
        padding: 0 2% 0.3em !important;
        margin: 0 0 1em;
        color: var(--title-color);
      }

      .timeText {
        font-size: 14px;
        color: var(--secondary-text);
        padding: 0 2%;
        margin: 0 0 1em;
      }
      /* 新增作者样式 */
      .meta-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 2%;
        margin: 0 0 1em;
      }

      .authorText {
        font-size: 14px;
        color: var(--secondary-text);
        font-style: italic;
      }

      .copy-button {
        float: right;
        border: none;
        border-radius: 2px;
        background-color: transparent;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .copy-button:hover {
        background-color: var(--button-hover-bg);
        color: var(--page-bg);
      }

      .markdown-body {
        font-family: var(--font-family);
        padding: 0 2% !important;
        background: transparent !important;
        color: var(--text-color);
      }

      .markdown-body pre {
        background-color: var(--code-bg);
        padding: 16px;
        border-radius: 6px;
        overflow-x: auto;
        transition: background-color 0.3s ease;
      }

      @media (max-width: 767px) {
        body {
          padding: 10px;
        }
        .container {
          padding: 0 10px;
        }
        .markdown-body {
          font-size: 14px;
        }
      }
    </style>

    <script>
      // Markdown 配置
      marked.setOptions({
        breaks: true,
        gfm: true,
        sanitize: true,
        highlight: function(code, lang) {
          return hljs.highlightAuto(code).value;
        }
      });

      var PATH_SEGMENTS_TO_SKIP = 0;

      function isUrl(url) {
        return /^[a-zA-z]+:\/\/[^\s]*$/.test(url);
      }

      function returnHome() {
        window.location.replace(
          location.protocol +
            '//' +
            location.hostname +
            (location.port ? ':' + location.port : '') +
            '/' +
            location.pathname.split('/')[PATH_SEGMENTS_TO_SKIP]
        );
      }

      function copyText() {
        const rawText = document.querySelector(".markdown-body").dataset.raw;
        const copyBtn = document.querySelector(".copy-button");
        
        const textarea = document.createElement("textarea");
        textarea.value = rawText;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand("copy");
        document.body.removeChild(textarea);

        copyBtn.innerHTML = '<svg t="1756180087741" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1990" width="1.2rem" height="1.2rem"><path d="M382.08 795.946667c18.730667 19.626667 49.066667 19.626667 67.84 0L924.586667 299.008a51.882667 51.882667 0 0 0 0-70.954667 46.464 46.464 0 0 0-67.84 0L416.085333 689.365333 167.253333 428.842667a46.464 46.464 0 0 0-67.84 0 51.882667 51.882667 0 0 0 0 70.997333l282.709334 296.106667z" fill="#34a852" p-id="1991"></path></svg>';
        setTimeout(() => {
          copyBtn.innerHTML = '<svg t="1756180022208" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1570" width="1.3rem" height="1.3rem"><path d="M554.666667 170.666667H298.666667a85.333333 85.333333 0 0 0-85.333334 85.333333v256a42.666667 42.666667 0 1 1-85.333333 0V256a170.666667 170.666667 0 0 1 170.666667-170.666667h256a170.666667 170.666667 0 0 1 170.666666 170.666667 128 128 0 0 1 128 128v298.666667a213.333333 213.333333 0 0 1-213.333333 213.333333h-213.333333a128 128 0 0 1-128-128 170.581333 170.581333 0 0 1-149.034667-87.466667l-0.085333-0.128a42.666667 42.666667 0 0 1 76.373333-38.186666l0.128-0.042667c15.061333 24.32 41.941333 40.490667 72.618667 40.490667h256a85.333333 85.333333 0 0 0 85.333333-85.333334V256a85.333333 85.333333 0 0 0-85.333333-85.333333z m170.666666 170.666666v256a170.666667 170.666667 0 0 1-170.666666 170.666667H384a42.666667 42.666667 0 0 0 42.666667 42.666667h213.333333a128 128 0 0 0 128-128V384a42.666667 42.666667 0 0 0-42.666667-42.666667zM341.333333 298.666667a42.666667 42.666667 0 0 0 0 85.333333h170.666667a42.666667 42.666667 0 1 0 0-85.333333H341.333333z m-42.666666 213.333333a42.666667 42.666667 0 0 1 42.666666-42.666667h170.666667a42.666667 42.666667 0 1 1 0 85.333334H341.333333a42.666667 42.666667 0 0 1-42.666666-42.666667z" fill="#ffffff" p-id="1571"></path></svg>';
        }, 1000);
      }

      function redirect() {
        var GITEE_ISSUES_LINK = atob('aHR0cHM6Ly9naXRlZS5jb20vYXBpL3Y1L3JlcG9zL3p3OTVjbi9zaG9ydHVybC1kYi9pc3N1ZXMv');
        var location = window.location;
        var issueNumber = location.pathname.split('/')[PATH_SEGMENTS_TO_SKIP + 1];
        var xhr = new XMLHttpRequest();

        xhr.onload = function () {
          if (xhr.status === 200) {
            var payload = JSON.parse(xhr.response);
            var message = payload.message;
            var titleText = payload.title;
            var bodyText = payload.body;
            var timeText = payload.updated_at;  
            var userName = payload.user?.name || '';

            var isInvalidUrl = message === 'Not Found' || 
                             message === 'This issue was deleted' || 
                             !titleText || 
                             (!isUrl(titleText) && !isUrl(bodyText));

            if (isInvalidUrl) {
              document.title = titleText;
              let container = document.createElement('div');
              container.className = 'container';

              let divObj = document.createElement('div');
              divObj.className = 'box';

              let titleObj = document.createElement('h1');
              titleObj.className = 'titleText';
              titleObj.textContent = titleText;

              // 创建元信息容器
              let metaContainer = document.createElement('div');
              metaContainer.className = 'meta-info';

              // 时间元素
              let timeObj = document.createElement('p');
              timeObj.className = 'timeText';
              let textTime = new Date(timeText);
              timeObj.textContent = textTime.toLocaleString();

              // 作者元素
              let authorObj = document.createElement('span');
              authorObj.className = 'authorText';
              authorObj.textContent = userName ? `作者：${userName}` :'';

              // 组装元素
              metaContainer.appendChild(timeObj);
              metaContainer.appendChild(authorObj);

              let copyBtnObj = document.createElement('button');
              copyBtnObj.className = 'copy-button';
              copyBtnObj.textContent = '复制';
              copyBtnObj.addEventListener('click', copyText);

              let bodyObj = document.createElement('div');
              bodyObj.className = 'markdown-body';
              bodyObj.innerHTML = marked.parse(bodyText);
              bodyObj.dataset.raw = bodyText; // 保存原始文本

              divObj.appendChild(titleObj);
              divObj.appendChild(metaContainer);
              divObj.appendChild(copyBtnObj);
              divObj.appendChild(bodyObj);

              container.appendChild(divObj);
              document.body.appendChild(container);

              // 代码高亮
              hljs.highlightAll();
            } else {
              document.title = '跳转中...';
              isUrl(titleText) ? location.replace(titleText) : location.replace(bodyText);
            }
          } else {
            console.error(xhr.status+' '+xhr.response);
            returnHome();
          }
        };

        xhr.onerror = returnHome;
        xhr.open('GET', GITEE_ISSUES_LINK + issueNumber);
        xhr.send();
      }

      try {
        redirect();
      } catch (e) {
        console.error(e);
        returnHome();
      }
    </script>
  </head>
  <body></body>
</html>